<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Condomínio Residencial D'Ouro - Registro de Visitantes</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" 
          rel="stylesheet" 
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" 
          crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>Condomínio Residencial D'Ouro</h1>
        <button class="btn btn-secondary" onclick="logout()">Sair</button>
    </div>
    <h2>Adicionar Visitante</h2>

    <form id="visitanteForm" autocomplete="off">
        <div class="mb-3">
            <label for="nome" class="form-label">Nome completo:</label>
            <input type="text" id="nome" class="form-control" autocomplete="off">
        </div>

        <div class="mb-3">
            <label for="cpf" class="form-label">CPF:</label>
            <input type="text" id="cpf" class="form-control" autocomplete="off">
        </div>

        <div class="mb-3">
            <label for="documento" class="form-label">Documento:</label>
            <input type="text" id="documento" class="form-control" autocomplete="off" required>
            <div class="invalid-feedback">Por favor, insira o documento.</div>
        </div>

        <div class="mb-3">
            <label for="condominio" class="form-label">Empresa/Condomínio:</label>
            <input type="text" id="condominio" class="form-control" autocomplete="off">
        </div>

        <div class="mb-3">
            <label for="contato" class="form-label">Celular:</label>
            <input type="text" id="contato" class="form-control" autocomplete="off">
        </div>

        <div class="mb-3">
            <label for="endereco" class="form-label">Endereço:</label>
            <input type="text" id="endereco" class="form-control" autocomplete="off">
        </div>

        <div class="mb-3">
            <label for="dataVisita" class="form-label">Data da Visita:</label>
            <input type="date" id="dataVisita" class="form-control">
        </div>

        <div class="mb-3">
            <label for="razao" class="form-label">Razão da Visita:</label>
            <input type="text" id="razao" class="form-control">
        </div>

        <!-- Select de casas -->
        <div class="mb-3">
            <label for="morador" class="form-label">Casa Visitada:</label>
            <select id="morador" class="form-select">
                <option value="">Selecione a casa</option>
            </select>
        </div>

        <!-- Select de moradores da casa -->
        <div class="mb-3">
            <label for="visitadoNome" class="form-label">Nome do Visitado:</label>
            <select id="visitadoNome" class="form-select">
                <option value="">Selecione o morador</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="telefoneVisitado" class="form-label">Telefone do Visitado:</label>
            <input type="text" id="telefoneVisitado" class="form-control" readonly>
        </div>

        <div class="mb-3">
            <label for="autorizador" class="form-label">Autorizador:</label>
            <input type="text" id="autorizador" class="form-control">
        </div>

        <div class="d-flex gap-2 mb-3">
            <button id="salvar-btn" type="submit" class="btn btn-success">Salvar</button>
            <button id="cancelar-btn" type="button" class="btn btn-danger">Cancelar</button>
            <a href="listar_visitantes.html" class="btn btn-primary">Visualizar Visitantes</a>
        </div>
    </form>

    <div id="mensagem" class="mt-2"></div>
</div>

<!-- Scripts -->
<script type="module" src="script_moradores.js"></script>
<script type="module" src="script.js"></script>

<script type="module">
// ----------------------------
// Funções de login e formulário
// ----------------------------
function verificarLogin() {
    if (sessionStorage.getItem("logado") !== "true") {
        window.location.href = "login.html";
    }
}

function logout() {
    sessionStorage.removeItem("logado");
    window.location.href = "login.html";
}

function limparFormulario() {
    document.getElementById('visitanteForm').reset();
    document.getElementById('telefoneVisitado').value = '';
}

// ----------------------------
// Inicializa selects e listeners
// ----------------------------
window.addEventListener('DOMContentLoaded', () => {
    verificarLogin();
    limparFormulario();

    // Preenche select de casas
    const selectCasa = document.getElementById('morador');
    if (selectCasa && window.moradores) {
        selectCasa.innerHTML = '<option value="">Selecione a casa</option>';
        window.moradores.forEach(c => {
            const option = document.createElement('option');
            option.value = c[0];
            option.text = c[0];
            selectCasa.appendChild(option);
        });
    }

    // Atualiza moradores ao mudar a casa
    selectCasa?.addEventListener('change', () => {
        const selectMorador = document.getElementById('visitadoNome');
        const casaSelecionada = selectCasa.value;
        window.popularMoradores(casaSelecionada, selectMorador);
        document.getElementById('telefoneVisitado').value = '';
    });

    // Atualiza telefone ao selecionar morador
    document.getElementById('visitadoNome')?.addEventListener('change', function() {
        const casa = document.getElementById('morador').value;
        const nome = this.value;
        document.getElementById('telefoneVisitado').value = window.obterTelefone(casa, nome);
    });

    // Cancelar botão
    document.getElementById('cancelar-btn')?.addEventListener('click', limparFormulario);

    // Formulário: salvar visitante
    const form = document.getElementById('visitanteForm');
    form?.addEventListener('submit', async (event) => {
        event.preventDefault();
        const { salvarVisitante } = await import('./apiVisitantes.js');

        const formData = {
            nome: document.getElementById('nome').value.trim(),
            cpf: document.getElementById('cpf').value.trim(),
            documento: document.getElementById('documento').value.trim(), // Adicionado: Campo documento
            empresa: document.getElementById('condominio').value.trim(),
            contato: document.getElementById('contato').value.trim(),
            endereco: document.getElementById('endereco').value.trim(),
            dataVisita: document.getElementById('dataVisita').value,
            razaoVisita: document.getElementById('razao').value.trim(),
            numeroCasa: document.getElementById('morador').value,
            nomeVisitado: document.getElementById('visitadoNome').value,
            telefoneVisitado: document.getElementById('telefoneVisitado').value,
            autorizador: document.getElementById('autorizador').value.trim()
        };

        try {
            await salvarVisitante(formData);
            document.getElementById('mensagem').innerHTML = 
                `<div class="alert alert-success">Visitante salvo com sucesso!</div>`;
            limparFormulario();
        } catch (error) {
            document.getElementById('mensagem').innerHTML = 
                `<div class="alert alert-danger">Erro ao salvar visitante: ${error.message}</div>`;
            console.error(error);
        }
    });
});
</script>

</body>
</html>

