<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Condomínio Residencial D'Ouro - Registro de Visitantes</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" 
          rel="stylesheet" 
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" 
          crossorigin="anonymous">

    <link rel="stylesheet" href="style.css">
</head>

<body onload="verificarLogin(); limparFormulario(); popularListaCasas();">
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>Condomínio Residencial D'Ouro</h1>
        <button class="btn btn-secondary" onclick="logout()">Sair</button>
    </div>

    <h2>Adicionar Visitante</h2>

    <form id="visitanteForm" autocomplete="off">
        <div class="mb-3">
            <label for="nome" class="form-label">Nome completo:</label>
            <input type="text" id="nome" class="form-control">
        </div>

        <div class="mb-3">
            <label for="cpf" class="form-label">CPF:</label>
            <input type="text" id="cpf" class="form-control">
        </div>

        <div class="mb-3">
            <label for="condominio" class="form-label">Empresa/Condomínio:</label>
            <input type="text" id="condominio" class="form-control">
        </div>

        <div class="mb-3">
            <label for="contato" class="form-label">Celular:</label>
            <input type="text" id="contato" class="form-control">
        </div>

        <div class="mb-3">
            <label for="endereco" class="form-label">Endereço:</label>
            <input type="text" id="endereco" class="form-control">
        </div>

        <div class="mb-3">
            <label for="dataVisita" class="form-label">Data da Visita:</label>
            <input type="date" id="dataVisita" class="form-control">
        </div>

        <div class="mb-3">
            <label for="razao" class="form-label">Razão da Visita:</label>
            <input type="text" id="razao" class="form-control">
        </div>

        <div class="mb-3">
            <label for="morador" class="form-label">Casa Visitada:</label>
            <select id="morador" class="form-select">
                <option value="">Selecione a casa</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="visitadoNome" class="form-label">Nome do Visitado:</label>
            <select id="visitadoNome" class="form-select">
                <option value="">Selecione o morador</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="telefoneVisitado" class="form-label">Telefone do Visitado:</label>
            <input type="text" id="telefoneVisitado" class="form-control" placeholder="Telefone do visitado">
        </div>

        <div class="mb-3">
            <label for="autorizadorSelect" class="form-label">Autorizador:</label>
            <select id="autorizadorSelect" class="form-select">
                <option value="">Selecione o autorizador</option>
            </select>
            <input type="text" id="autorizadorInput" class="form-control mt-2 d-none" placeholder="Digite o nome do autorizador">
        </div>

        <div class="d-flex gap-2 mb-3">
            <button id="salvar-btn" type="submit" class="btn btn-success">Salvar</button>
            <button id="cancelar-btn" type="button" class="btn btn-danger">Cancelar</button>
            <a href="listar_visitantes.html" class="btn btn-primary">Visualizar Visitantes</a>
        </div>
    </form>

    <div id="mensagem" class="mt-2"></div>
</div>

<!-- Scripts -->
<script type="module" src="script_moradores.js"></script>
<script type="module" src="script.js"></script>

<script>
    function verificarLogin() {
        if (sessionStorage.getItem("logado") !== "true") {
            window.location.href = "login.html";
        }
    }

    function logout() {
        sessionStorage.removeItem("logado");
        window.location.href = "login.html";
    }

    function limparFormulario() {
        document.getElementById('visitanteForm').reset();
        document.getElementById('telefoneVisitado').value = '';
        document.getElementById('autorizadorInput').classList.add('d-none');
        document.getElementById('autorizadorInput').value = '';
    }

    function popularListaCasas() {
        const select = document.getElementById('morador');
        if (!select) return;
        select.innerHTML = '<option value="">Selecione a casa</option>';
        for (let i = 1; i <= 20; i++) {
            const option = document.createElement('option');
            option.value = `C${i}`;
            option.text = `C${i}`;
            select.appendChild(option);
        }
    }

    function atualizarMoradores() {
        const casaSelecionada = document.getElementById('morador').value;
        const selectMorador = document.getElementById('visitadoNome');
        selectMorador.innerHTML = '<option value="">Selecione o morador</option>';

        const selectAutorizador = document.getElementById('autorizadorSelect');
        selectAutorizador.innerHTML = '<option value="">Selecione o autorizador</option>';

        if (!casaSelecionada || !window.moradores) return;

        const idCasa = casaSelecionada.replace('C','');
        const casa = window.moradores.find(c => c[0] === idCasa);
        if (casa) {
            casa.slice(1).forEach(morador => {
                if (morador && morador.nome) {
                    const optionVisitado = document.createElement('option');
                    optionVisitado.value = morador.nome;
                    optionVisitado.textContent = morador.nome;
                    selectMorador.appendChild(optionVisitado);

                    const optionAutorizador = document.createElement('option');
                    optionAutorizador.value = morador.nome;
                    optionAutorizador.textContent = morador.nome;
                    selectAutorizador.appendChild(optionAutorizador);
                }
            });
            const optionOutro = document.createElement('option');
            optionOutro.value = 'Outro';
            optionOutro.textContent = 'Outro';
            selectAutorizador.appendChild(optionOutro);
        }

        document.getElementById('telefoneVisitado').value = '';
    }

    document.getElementById('visitadoNome')?.addEventListener('change', function() {
        const casaSelecionada = document.getElementById('morador').value;
        const moradorSelecionado = this.value;
        const telefoneInput = document.getElementById('telefoneVisitado');
        telefoneInput.value = '';

        if (!casaSelecionada || !moradorSelecionado || !window.moradores) return;

        const idCasa = casaSelecionada.replace('C','');
        const casa = window.moradores.find(c => c[0] === idCasa);
        if (casa) {
            const morador = casa.slice(1).find(m => m.nome === moradorSelecionado);
            if (morador && morador.telefone) {
                telefoneInput.value = morador.telefone;
            }
        }
    });

    document.getElementById('morador')?.addEventListener('change', atualizarMoradores);
    document.getElementById('cancelar-btn')?.addEventListener('click', limparFormulario);

    document.getElementById('autorizadorSelect')?.addEventListener('change', function() {
        const input = document.getElementById('autorizadorInput');
        if (this.value === 'Outro') {
            input.classList.remove('d-none');
            input.focus();
        } else {
            input.classList.add('d-none');
            input.value = '';
        }
    });

    document.getElementById('telefoneVisitado').removeAttribute('readonly');
    document.getElementById('telefoneVisitado').disabled = false;

    // =========================
    // Adiciona funcionalidade ao botão Salvar
    // =========================
    document.getElementById('visitanteForm')?.addEventListener('submit', async function(event) {
        event.preventDefault();

        const visitante = {
            nome: document.getElementById('nome').value,
            cpf: document.getElementById('cpf').value,
            condominio: document.getElementById('condominio').value,
            contato: document.getElementById('contato').value,
            endereco: document.getElementById('endereco').value,
            dataVisita: document.getElementById('dataVisita').value,
            razao: document.getElementById('razao').value,
            morador: document.getElementById('morador').value,
            visitadoNome: document.getElementById('visitadoNome').value,
            telefoneVisitado: document.getElementById('telefoneVisitado').value,
            autorizador: document.getElementById('autorizadorSelect').value === 'Outro'
                ? document.getElementById('autorizadorInput').value
                : document.getElementById('autorizadorSelect').value
        };

        try {
            const response = await salvarVisitante(visitante);
            const msgDiv = document.getElementById('mensagem');
            if (response && response.id) {
                msgDiv.textContent = 'Visitante salvo com sucesso!';
                msgDiv.classList.remove('text-danger');
                msgDiv.classList.add('text-success');
                limparFormulario();
            } else {
                msgDiv.textContent = 'Erro ao salvar visitante.';
                msgDiv.classList.remove('text-success');
                msgDiv.classList.add('text-danger');
            }
        } catch (error) {
            console.error(error);
            const msgDiv = document.getElementById('mensagem');
            msgDiv.textContent = 'Erro ao salvar visitante.';
            msgDiv.classList.remove('text-success');
            msgDiv.classList.add('text-danger');
        }
    });
</script>
</body>
</html>

