<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagramas - Sistema Registro Visitantes</title>
    <!-- Biblioteca para captura de imagens -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <!-- Mermaid para renderizar diagramas -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: white;
            line-height: 1.6;
        }
        
        .diagram-container {
            margin: 40px 0;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 10px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .diagram-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        
        .diagram-content {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            background: white;
        }
        
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        
        button {
            padding: 12px 24px;
            margin: 0 10px;
            border: none;
            border-radius: 8px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .download-btn {
            background: #28a745;
        }
        
        .download-btn:hover {
            background: #218838;
        }
        
        .info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            font-size: 14px;
            color: #6c757d;
        }
        
        /* Ajustes para captura */
        .capture-mode .controls,
        .capture-mode .info {
            display: none !important;
        }
        
        .capture-mode .diagram-container {
            margin: 10px;
            box-shadow: none;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <h1 style="text-align: center; color: #333; margin-bottom: 30px;">
        Diagramas - Sistema de Registro de Visitantes
    </h1>
    
    <div class="controls">
        <button onclick="downloadDER()" class="download-btn">üìä Baixar DER</button>
        <button onclick="downloadHistoriaUsuario()" class="download-btn">üë§ Baixar Hist√≥ria do Usu√°rio</button>
        <button onclick="downloadAmbos()" class="download-btn">üìÅ Baixar Ambos</button>
    </div>
    
    <div class="info">
        <strong>Instru√ß√µes:</strong> Clique nos bot√µes acima para baixar os diagramas em formato PNG de alta qualidade. 
        Os arquivos ser√£o salvos com nomes descritivos e prontos para uso em documentos Word, PowerPoint ou qualquer outra aplica√ß√£o.
    </div>

    <!-- Diagrama Entidade-Relacionamento -->
    <div class="diagram-container" id="der-container">
        <div class="diagram-title">Diagrama Entidade-Relacionamento (DER)</div>
        <div class="diagram-content">
            <div class="mermaid" id="der-diagram">
erDiagram
    CONDOMINIOS ||--o{ MORADORES : "possui"
    MORADORES ||--o{ VISITANTES : "recebe"
    USUARIOS ||--o{ VISITANTES : "registra"

    CONDOMINIOS {
        LONG id PK
        STRING nome "NOT NULL"
    }
    
    MORADORES {
        LONG id PK
        STRING nome_morador "NOT NULL"
        INTEGER casa "NOT NULL"
        LONG condominio_id FK "NOT NULL"
    }
    
    VISITANTES {
        LONG id PK
        STRING nome "NOT NULL"
        STRING documento "NOT NULL, UNIQUE"
        STRING veiculo "NULLABLE"
        STRING motivo "NULLABLE"
        DATETIME entrada "NOT NULL"
        DATETIME saida "NULLABLE"
        DATE data_visita "NULLABLE"
        STRING razao_visita "NULLABLE"
        STRING numero_casa "NULLABLE"
        STRING nome_visitado "NULLABLE"
        STRING telefone_visitado "NULLABLE"
        STRING autorizador "NULLABLE"
        LONG morador_id FK "NULLABLE"
    }
    
    USUARIOS {
        LONG id PK
        STRING email "NOT NULL, UNIQUE"
        STRING password_hash "NOT NULL"
        BOOLEAN is_admin "NOT NULL, DEFAULT FALSE"
        DATETIME created_at "NOT NULL"
    }
            </div>
        </div>
    </div>

    <!-- Diagrama Hist√≥ria do Usu√°rio -->
    <div class="diagram-container" id="historia-container">
        <div class="diagram-title">Hist√≥ria do Usu√°rio - Fluxo de Intera√ß√µes</div>
        <div class="diagram-content">
            <div class="mermaid" id="historia-diagram">
flowchart LR
    %% === LAYOUT RETANGULAR ORGANIZADO ===
    
    %% COLUNA 1: ATORES
    subgraph Col1 ["üë• ATORES"]
        direction TB
        A1["üë§<br/>VISITANTE"]
        A2["üö™<br/>PORTEIRO"] 
        A3["üè†<br/>MORADOR"]
        A4["‚öôÔ∏è<br/>ADMIN"]
    end
    
    %% COLUNA 2: FRONTEND
    subgraph Col2 ["üì± FRONTEND"]
        direction TB
        F1["üîê<br/>login.html"]
        F2["üìù<br/>visitantes.html"]
        F3["üìã<br/>listar_visitantes.html"]
        F4["üë•<br/>moradores.html"]
    end
    
    %% COLUNA 3: BACKEND
    subgraph Col3 ["üîß BACKEND"]
        direction TB
        B1["üéØ<br/>VisitanteController"]
        B2["üéØ<br/>MoradorController"]
        B3["üîë<br/>AuthController"]
    end
    
    %% COLUNA 4: DATABASE
    subgraph Col4 ["üóÑÔ∏è DATABASE"]
        direction TB
        D1[("üìä<br/>visitantes")]
        D2[("üë§<br/>moradores")]
        D3[("üîê<br/>usuarios")]
        D4[("üè¢<br/>condominios")]
    end
    
    %% === CONEX√ïES PERPENDICULARES ===
    
    %% Fluxo 1: Login (Horizontal)
    A2 ---|1| F1
    F1 ---|2| B3  
    B3 ---|3| D3
    
    %% Fluxo 2: Registro Visitante (Horizontal)
    A1 ---|4| F2
    F2 ---|5| B1
    B1 ---|6| D1
    B1 ---|7| D2
    
    %% Fluxo 3: Consulta (Horizontal) 
    A2 ---|8| F3
    F3 ---|9| B1
    B1 ---|10| D1
    
    %% Fluxo 4: Gest√£o Moradores (Horizontal)
    A4 ---|11| F4
    F4 ---|12| B2
    B2 ---|13| D2
    B2 ---|14| D4
    
    %% Autoriza√ß√£o Morador (Vertical)
    A3 ---|15| D2
    
    %% === ESTILOS LIMPOS ===
    classDef actor fill:#FFE6E6,stroke:#CC0000,stroke-width:2px,color:#000
    classDef frontend fill:#E6F3FF,stroke:#0066CC,stroke-width:2px,color:#000  
    classDef backend fill:#E6FFE6,stroke:#00AA00,stroke-width:2px,color:#000
    classDef database fill:#FFF0E6,stroke:#FF6600,stroke-width:2px,color:#000
    
    class A1,A2,A3,A4 actor
    class F1,F2,F3,F4 frontend
    class B1,B2,B3 backend
    class D1,D2,D3,D4 database
            </div>
        </div>
    </div>

    <div class="info">
        <strong>Especifica√ß√µes dos Downloads:</strong>
        <ul>
            <li><strong>Formato:</strong> PNG de alta qualidade</li>
            <li><strong>Resolu√ß√£o:</strong> Otimizada para impress√£o e visualiza√ß√£o</li>
            <li><strong>Uso:</strong> Perfeito para Word, PowerPoint, relat√≥rios t√©cnicos</li>
            <li><strong>Qualidade:</strong> Vetorial renderizado em alta defini√ß√£o</li>
        </ul>
    </div>

    <script>
        // Inicializar Mermaid
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true
            },
            er: {
                useMaxWidth: true
            }
        });

        // Fun√ß√£o para baixar o DER
        async function downloadDER() {
            await capturarDiagrama('der-container', 'Diagrama_Entidade_Relacionamento_DER');
        }

        // Fun√ß√£o para baixar Hist√≥ria do Usu√°rio
        async function downloadHistoriaUsuario() {
            await capturarDiagrama('historia-container', 'Historia_do_Usuario_Fluxo_Interacoes');
        }

        // Fun√ß√£o para baixar ambos
        async function downloadAmbos() {
            document.querySelectorAll('button').forEach(btn => {
                btn.disabled = true;
                btn.textContent = btn.textContent.replace(/üìä|üë§|üìÅ/, '‚è≥');
            });

            await capturarDiagrama('der-container', 'Diagrama_Entidade_Relacionamento_DER');
            
            // Pausa entre downloads
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await capturarDiagrama('historia-container', 'Historia_do_Usuario_Fluxo_Interacoes');

            // Restaurar bot√µes
            setTimeout(() => {
                document.querySelectorAll('button').forEach(btn => {
                    btn.disabled = false;
                });
                document.querySelector('button[onclick="downloadDER()"]').textContent = 'üìä Baixar DER';
                document.querySelector('button[onclick="downloadHistoriaUsuario()"]').textContent = 'üë§ Baixar Hist√≥ria do Usu√°rio';
                document.querySelector('button[onclick="downloadAmbos()"]').textContent = 'üìÅ Baixar Ambos';
                
                alert('Ambos os diagramas foram baixados com sucesso!');
            }, 500);
        }

        // Fun√ß√£o para capturar diagrama
        async function capturarDiagrama(containerId, nomeArquivo) {
            const container = document.getElementById(containerId);
            
            // Entra no modo captura
            document.body.classList.add('capture-mode');
            
            // Aguarda um pouco para aplicar o CSS
            await new Promise(resolve => setTimeout(resolve, 200));
            
            try {
                const canvas = await html2canvas(container, {
                    backgroundColor: '#ffffff',
                    scale: 2, // Alta resolu√ß√£o
                    useCORS: true,
                    allowTaint: true,
                    height: container.scrollHeight,
                    width: container.scrollWidth
                });
                
                // Criar link para download
                const link = document.createElement('a');
                link.download = `${nomeArquivo}.png`;
                link.href = canvas.toDataURL('image/png', 1.0);
                link.click();
                
            } catch (error) {
                console.error('Erro ao capturar diagrama:', error);
                alert('Erro ao gerar a imagem. Tente usar Print Screen manualmente.');
            }
            
            // Sai do modo captura
            document.body.classList.remove('capture-mode');
        }
    </script>
</body>
</html>